<!DOCTYPE html>
<html lang="ms">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PERKESO Keningau - Penilaian Pelanggan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            cursor: pointer;
            color: #cbd5e1;
            font-size: 1.5rem;
            transition: color 0.2s;
        }

        .star-rating input:checked~label,
        .star-rating label:hover,
        .star-rating label:hover~label {
            color: #fbbf24;
        }

        .hidden-section {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800">

    <!-- Navbar -->
    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="perkeso-logo.jpg" alt="Logo PERKESO" class="w-12 h-12 bg-white rounded-full object-cover">
                <div>
                    <h1 class="font-bold text-lg leading-tight">PERKESO Keningau</h1>
                    <p class="text-xs text-blue-200">Sistem Penilaian Pelanggan 1Serve</p>
                </div>
            </div>
            <button onclick="toggleAdmin()"
                class="text-xs bg-blue-800 hover:bg-blue-700 px-3 py-1 rounded transition">Admin</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container mx-auto p-4 max-w-lg mb-20">

        <!-- SUCCESS MESSAGE (Regular Feedback) -->
        <div id="success-screen"
            class="hidden-section flex flex-col items-center justify-center text-center space-y-6 py-10 fade-in">
            <div
                class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-4xl mb-2 shadow-sm">
                &#10003;</div>
            <h2 class="text-2xl font-bold text-slate-800">Terima Kasih!</h2>
            <p class="text-slate-600">Maklum balas anda telah direkodkan. Kami menghargai masa anda.</p>
            <button onclick="location.reload()"
                class="mt-8 bg-blue-600 text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:bg-blue-700 transition w-full">Kembali</button>
        </div>

        <!-- SUCCESS MESSAGE (Penghargaan) -->
        <div id="penghargaan-success"
            class="hidden-section flex flex-col items-center justify-center text-center space-y-6 py-10 fade-in">
            <div
                class="w-20 h-20 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-full flex items-center justify-center text-4xl mb-2 shadow-sm">
                üèÜ</div>
            <h2 class="text-2xl font-bold text-orange-900">Penghargaan Diterima!</h2>
            <p class="text-slate-600">Terima kasih atas pengiktirafan anda. Penghargaan ini akan disampaikan kepada staf
                berkenaan.</p>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 max-w-sm text-left space-y-2">
                <p class="text-sm text-orange-800">
                    <strong>Nama:</strong> <span id="penghargaan-nama-display">-</span><br>
                    <strong>Kaunter:</strong> <span id="penghargaan-kaunter-display">-</span>
                </p>
                <p class="text-sm text-slate-700 pt-2 border-t border-yellow-200">
                    <strong>No. Rujukan:</strong> <span id="penghargaan-rujukan-display" class="font-mono">-</span>
                </p>
                <p class="text-xs text-slate-500">Simpan no. rujukan untuk semakan. Rekod disimpan dengan tarikh/masa.</p>
            </div>
            <button onclick="location.reload()"
                class="mt-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white px-6 py-3 rounded-full font-semibold shadow-lg hover:from-yellow-600 hover:to-orange-600 transition w-full">Kembali
                ke Utama</button>
        </div>

        <!-- PENGHARGAAN FORM (Hidden by default) -->
        <div id="penghargaan-form" class="hidden-section fade-in">
            <div
                class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl shadow-sm border-2 border-yellow-300 p-6 mb-6 relative overflow-hidden">
                <!-- Decorative background -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-yellow-200 rounded-full -mr-16 -mt-16 opacity-50"></div>

                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="text-3xl">üèÜ</span>
                        <div>
                            <h2 class="text-xl font-bold text-orange-900">Penghargaan Staf</h2>
                            <p class="text-sm text-orange-700">Berikan penghargaan kepada staf yang cemerlang</p>
                            <p class="text-xs text-slate-600 mt-1 bg-white/60 rounded px-2 py-1 border border-yellow-200">
                                <strong>Ketelusan:</strong> Setiap penghargaan direkodkan dengan tarikh dan masa. Rekod boleh disemak oleh pengurusan. Satu penghargaan dibenarkan per peranti per hari.
                            </p>
                        </div>
                    </div>

                    <div id="penghargaan-limit-msg" class="hidden mb-4 p-3 bg-amber-100 border border-amber-300 rounded-lg text-sm text-amber-800">
                        Anda telah menghantar penghargaan hari ini. Satu penghargaan dibenarkan per peranti per hari untuk memastikan ketelusan.
                    </div>
                    <form id="penghargaanForm" class="space-y-4">
                        <div class="bg-white rounded-lg p-4 border border-yellow-200">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                Nama Pegawai <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="nama_pegawai" required
                                placeholder="Contoh: Encik Ahmad bin Abdullah"
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none">
                            <p class="text-xs text-slate-500 mt-1">Sila nyatakan nama penuh atau nama staf yang melayani
                                anda</p>
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-yellow-200">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                Kaunter <span class="text-red-500">*</span>
                            </label>
                            <select name="kaunter_penghargaan" required
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none">
                                <option value="" disabled selected>Pilih Kaunter...</option>
                                <option value="Kaunter 1">Kaunter 1</option>
                                <option value="Kaunter 2">Kaunter 2</option>
                            </select>
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-yellow-200">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">
                                Ucapan Penghargaan (Pilihan)
                            </label>
                            <textarea name="ucapan_penghargaan" rows="3" placeholder="Terima kasih atas..."
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-yellow-500 outline-none resize-none"></textarea>
                        </div>

                        <div class="bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
                            <div class="bg-slate-50 border-b border-slate-200 px-4 py-3">
                                <h3 class="text-sm font-semibold text-slate-800">Bukti pemberi (untuk semakan)</h3>
                                <p class="text-xs text-slate-500 mt-0.5">Sila isi nama atau 4 digit terakhir no. telefon. Salah satu wajib; maklumat untuk semakan dalaman sahaja.</p>
                            </div>
                            <div class="p-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div>
                                        <label for="nama_pemberi" class="block text-xs font-medium text-slate-600 uppercase tracking-wide mb-1.5">Nama pemberi</label>
                                        <input type="text" name="nama_pemberi" id="nama_pemberi"
                                            placeholder="Contoh: Siti"
                                            class="w-full bg-white border border-slate-200 rounded-md px-3 py-2.5 text-sm text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-600 focus:border-blue-500 outline-none transition">
                                    </div>
                                    <div>
                                        <label for="telefon_4digit" class="block text-xs font-medium text-slate-600 uppercase tracking-wide mb-1.5">No. telefon (4 digit terakhir)</label>
                                        <input type="text" name="telefon_4digit" id="telefon_4digit" maxlength="4" pattern="[0-9]{4}" inputmode="numeric"
                                            placeholder="Contoh: 5678"
                                            class="w-full bg-white border border-slate-200 rounded-md px-3 py-2.5 text-sm text-slate-800 placeholder-slate-400 focus:ring-2 focus:ring-blue-600 focus:border-blue-500 outline-none transition">
                                    </div>
                                </div>
                                <p class="text-xs text-slate-500 mt-3">Wajib isi salah satu untuk ketelusan.</p>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-2">
                            <button type="button" onclick="togglePenghargaan()"
                                class="flex-1 bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold py-3 rounded-lg transition">
                                Kembali
                            </button>
                            <button type="submit" id="penghargaanBtn"
                                class="flex-1 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold py-3 rounded-lg shadow-lg transform transition active:scale-95 flex justify-center items-center">
                                <span id="penghargaanBtnText">Hantar Penghargaan</span>
                                <svg id="penghargaanBtnLoader" class="animate-spin ml-2 h-5 w-5 text-white hidden"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- CUSTOMER FORM -->
        <div id="customer-form" class="fade-in">
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4 text-blue-900 border-b pb-2">Butiran Urusan</h2>

                <form id="feedbackForm" class="space-y-5">
                    <!-- Dropdowns -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Kaunter</label>
                            <select name="kaunter" required
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="" disabled selected>Pilih...</option>
                                <option value="Kaunter 1">Kaunter 1</option>
                                <option value="Kaunter 2">Kaunter 2</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Urusan</label>
                            <select name="tujuan" required
                                class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="" disabled selected>Pilih...</option>
                                <option value="Tuntutan Faedah">Tuntutan Faedah</option>
                                <option value="Caruman">Caruman</option>
                                <option value="Pendaftaran">Pendaftaran</option>
                                <option value="Pertanyaan">Pertanyaan</option>
                                <option value="Lain-lain">Lain-lain</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ratings -->
                    <div class="space-y-4 pt-2">
                        <!-- Kemesraan -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <label class="block text-sm font-semibold text-blue-900 mb-2">Kemesraan Staf <span
                                    class="text-red-500">*</span></label>
                            <div class="star-rating flex flex-row-reverse justify-center gap-1">
                                <input type="radio" name="skor_mesra" id="mesra5" value="5" required><label
                                    for="mesra5">&#9733;</label>
                                <input type="radio" name="skor_mesra" id="mesra4" value="4"><label
                                    for="mesra4">&#9733;</label>
                                <input type="radio" name="skor_mesra" id="mesra3" value="3"><label
                                    for="mesra3">&#9733;</label>
                                <input type="radio" name="skor_mesra" id="mesra2" value="2"><label
                                    for="mesra2">&#9733;</label>
                                <input type="radio" name="skor_mesra" id="mesra1" value="1"><label
                                    for="mesra1">&#9733;</label>
                            </div>
                            <p class="text-center text-xs text-slate-500 mt-1">1 = Sangat Tidak Puas, 5 = Sangat Puas
                            </p>
                        </div>

                        <!-- Kepantasan -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <label class="block text-sm font-semibold text-blue-900 mb-2">Kepantasan Urusan <span
                                    class="text-red-500">*</span></label>
                            <div class="star-rating flex flex-row-reverse justify-center gap-1">
                                <input type="radio" name="skor_pantas" id="pantas5" value="5" required><label
                                    for="pantas5">&#9733;</label>
                                <input type="radio" name="skor_pantas" id="pantas4" value="4"><label
                                    for="pantas4">&#9733;</label>
                                <input type="radio" name="skor_pantas" id="pantas3" value="3"><label
                                    for="pantas3">&#9733;</label>
                                <input type="radio" name="skor_pantas" id="pantas2" value="2"><label
                                    for="pantas2">&#9733;</label>
                                <input type="radio" name="skor_pantas" id="pantas1" value="1"><label
                                    for="pantas1">&#9733;</label>
                            </div>
                            <p class="text-center text-xs text-slate-500 mt-1">1 = Sangat Lambat, 5 = Sangat Pantas</p>
                        </div>

                        <!-- Kejelasan -->
                        <div class="bg-blue-50 rounded-lg p-4">
                            <label class="block text-sm font-semibold text-blue-900 mb-2">Kejelasan Penerangan <span
                                    class="text-red-500">*</span></label>
                            <div class="star-rating flex flex-row-reverse justify-center gap-1">
                                <input type="radio" name="skor_jelas" id="jelas5" value="5" required><label
                                    for="jelas5">&#9733;</label>
                                <input type="radio" name="skor_jelas" id="jelas4" value="4"><label
                                    for="jelas4">&#9733;</label>
                                <input type="radio" name="skor_jelas" id="jelas3" value="3"><label
                                    for="jelas3">&#9733;</label>
                                <input type="radio" name="skor_jelas" id="jelas2" value="2"><label
                                    for="jelas2">&#9733;</label>
                                <input type="radio" name="skor_jelas" id="jelas1" value="1"><label
                                    for="jelas1">&#9733;</label>
                            </div>
                            <p class="text-center text-xs text-slate-500 mt-1">1 = Sangat Keliru, 5 = Sangat Jelas</p>
                        </div>
                    </div>

                    <!-- Improvements -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-3">Cadangan Perbaikan (Pilihan
                            berbilang)</label>
                        <div class="grid grid-cols-2 gap-3">
                            <label
                                class="flex items-center space-x-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:border-blue-400 transition">
                                <input type="checkbox" name="kategori_perbaikan" value="Waktu Menunggu"
                                    class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-600">Waktu Menunggu</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:border-blue-400 transition">
                                <input type="checkbox" name="kategori_perbaikan" value="Fasiliti"
                                    class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-600">Fasiliti</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:border-blue-400 transition">
                                <input type="checkbox" name="kategori_perbaikan" value="Sikap Staf"
                                    class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-600">Sikap Staf</span>
                            </label>
                            <label
                                class="flex items-center space-x-2 bg-slate-50 p-3 rounded-lg border border-slate-200 cursor-pointer hover:border-blue-400 transition">
                                <input type="checkbox" name="kategori_perbaikan" value="Sistem Giliran"
                                    class="rounded text-blue-600 focus:ring-blue-500">
                                <span class="text-sm text-slate-600">Sistem Giliran</span>
                            </label>
                        </div>
                    </div>

                    <!-- Comment -->
                    <div>
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Ulasan / Komen</label>
                        <textarea name="ulasan" rows="3" placeholder="Sila kongsikan maklum balas atau cadangan anda..."
                            class="w-full bg-slate-50 border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none resize-none"></textarea>
                    </div>

                    <!-- Penghargaan Button -->
                    <button type="button" onclick="togglePenghargaan()"
                        class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white font-semibold py-3 rounded-xl shadow-lg transform hover:scale-[1.02] transition flex items-center justify-center gap-2 mb-4"
                        title="Berikan Penghargaan kepada Staf">
                        <span class="text-xl">‚≠ê</span>
                        <span>Beri Penghargaan kepada Petugas</span>
                    </button>

                    <!-- Submit Button -->
                    <button type="submit" id="submitBtn"
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 flex justify-center items-center">
                        <span id="btnText">Hantar Penilaian</span>
                        <svg id="btnLoader" class="animate-spin ml-2 h-5 w-5 text-white hidden"
                            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                    </button>
                    <div class="mt-6 pt-4 border-t border-slate-200">
                        <p class="text-center text-xs text-slate-500 mb-1">
                            <strong>Pejabat PERKESO Keningau</strong><br>
                            Tingkat 1 & 2, Lot 22, Blok B, ADIKA Commercial Complex,<br>
                            Peti Surat 704, 89008 Keningau
                        </p>
                        <p class="text-center text-xs text-slate-400 mt-2">Hak Cipta Terpelihara &copy; 2024 PERKESO
                            Keningau</p>
                    </div>
                </form>
            </div>
        </div>

        <!-- ADMIN DASHBOARD -->
        <div id="admin-dashboard" class="hidden-section pb-20 fade-in">
            <!-- Login Overlay -->
            <div id="admin-login" class="bg-white rounded-xl shadow-md p-6 border border-slate-200 mb-6">
                <div class="text-center mb-6">
                    <div
                        class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-2xl mx-auto mb-3">
                        &#128274;</div>
                    <h3 class="text-lg font-bold text-slate-800">Akses Admin</h3>
                    <p class="text-sm text-slate-500">Sila masukkan kata laluan untuk mengakses dashboard</p>
                </div>
                <input type="password" id="adminPass" placeholder="Kata Laluan"
                    class="w-full border border-slate-300 rounded-lg p-3 mb-3 focus:ring-2 focus:ring-blue-500 outline-none"
                    onkeypress="if(event.key==='Enter')checkAdmin()">
                <button onclick="checkAdmin()"
                    class="w-full bg-blue-600 text-white rounded-lg p-3 text-sm font-bold hover:bg-blue-700 transition">Log
                    Masuk</button>
                <button onclick="toggleAdmin()" class="w-full mt-2 text-slate-500 text-sm hover:text-slate-700">Kembali
                    ke Borang</button>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden-section space-y-6">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-slate-800">Dashboard Prestasi</h2>
                    <div class="flex gap-2">
                        <button onclick="loadDashboardData()"
                            class="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 transition">Refresh
                            Data</button>
                        <button onclick="logoutAdmin()" class="text-sm text-red-500 hover:text-red-700">Log
                            Keluar</button>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-4 rounded-xl shadow-md text-white">
                        <div class="text-3xl font-bold" id="stat-total">0</div>
                        <div class="text-xs text-blue-100 uppercase tracking-wider">Jumlah Maklum Balas</div>
                    </div>
                    <div class="bg-gradient-to-br from-cyan-500 to-cyan-600 p-4 rounded-xl shadow-md text-white">
                        <div class="text-3xl font-bold" id="stat-avg">0.0</div>
                        <div class="text-xs text-cyan-100 uppercase tracking-wider">Purata Keseluruhan</div>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-slate-200">
                        <div class="text-2xl font-bold text-blue-600" id="stat-mesra">-</div>
                        <div class="text-[10px] text-slate-500 uppercase">Kemesraan</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-slate-200">
                        <div class="text-2xl font-bold text-blue-600" id="stat-pantas">-</div>
                        <div class="text-[10px] text-slate-500 uppercase">Kepantasan</div>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm text-center border border-slate-200">
                        <div class="text-2xl font-bold text-blue-600" id="stat-jelas">-</div>
                        <div class="text-[10px] text-slate-500 uppercase">Kejelasan</div>
                    </div>
                </div>

                <!-- Penghargaan Stats -->
                <div class="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-xl p-4 border-2 border-yellow-300">
                    <h3 class="font-bold text-orange-900 mb-3 flex items-center gap-2">
                        <span>üèÜ</span>
                        <span>Penghargaan Staf</span>
                        <span class="bg-orange-500 text-white px-2 py-0.5 rounded text-xs"
                            id="penghargaan-count">0</span>
                    </h3>
                    <p class="text-xs text-slate-600 mb-2">Rekod disimpan dengan tarikh/masa untuk ketelusan dan semakan.</p>
                    <div id="penghargaan-list" class="space-y-2 max-h-48 overflow-y-auto">
                        <p class="text-sm text-orange-700 text-center py-2">Tiada penghargaan direkodkan</p>
                    </div>
                </div>

                <!-- AI Insight Card -->
                <div
                    class="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-xl p-6 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                    <div class="flex justify-between items-start z-10 relative">
                        <div>
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <span>Gemini AI Analysis</span>
                                <span class="bg-green-400/30 px-2 py-0.5 rounded text-xs">AI</span>
                            </h3>
                            <p class="text-indigo-200 text-xs mb-4">Analisis sentimen dari ulasan pelanggan</p>
                        </div>
                    </div>

                    <div id="ai-result"
                        class="bg-white/10 backdrop-blur rounded-lg p-4 text-sm leading-relaxed mb-4 min-h-[120px] whitespace-pre-line">
                        Klik butang di bawah untuk menjana analisis sentimen dari 10-20 ulasan terkini menggunakan
                        Gemini AI.
                    </div>

                    <button onclick="runGeminiAnalysis()" id="aiBtn"
                        class="w-full bg-white text-indigo-700 font-bold py-3 rounded-lg hover:bg-indigo-50 transition flex justify-center items-center gap-2">
                        <svg id="aiSpinner" class="animate-spin h-5 w-5 hidden" xmlns="http://www.w3.org/2000/svg"
                            fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor"
                                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                            </path>
                        </svg>
                        <span id="aiBtnText">Jana Analisis Sentimen</span>
                    </button>
                </div>

                <!-- Alamat Pejabat -->
                <div class="bg-blue-50 rounded-xl border border-blue-200 p-4 mb-6">
                    <h3 class="font-bold text-blue-900 mb-2 flex items-center gap-2">
                        <span>üìç</span>
                        <span>Alamat Pejabat</span>
                    </h3>
                    <p class="text-sm text-blue-800 leading-relaxed">
                        <strong>Pejabat PERKESO Keningau</strong><br>
                        Tingkat 1 & 2, Lot 22, Blok B,<br>
                        ADIKA Commercial Complex,<br>
                        Peti Surat 704, 89008 Keningau
                    </p>
                </div>

                <!-- QR Code Generator -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span class="text-2xl">üì±</span>
                        <span>Jana QR Code</span>
                    </h3>
                    <p class="text-sm text-slate-600 mb-4">Cetak QR code ini untuk diletakkan di kaunter. Pelanggan
                        boleh imbas untuk memberi maklum balas.</p>

                    <div class="flex flex-col items-center gap-4">
                        <div id="qrcode" class="bg-white p-4 rounded-lg border-2 border-slate-200"></div>

                        <div class="flex gap-2 w-full">
                            <input type="text" id="qrUrl" placeholder="URL untuk QR code..."
                                class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                                value="">
                            <button onclick="generateQR()"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700 transition">
                                Jana
                            </button>
                        </div>

                        <div class="flex gap-2 w-full">
                            <button onclick="printQR()"
                                class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition">
                                üñ®Ô∏è Cetak QR Code
                            </button>
                            <button onclick="downloadQR()"
                                class="flex-1 bg-slate-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-slate-700 transition">
                                üíæ Muat Turun
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Feedback Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <span>Maklum Balas Terkini</span>
                        <span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs" id="feedback-count">0
                            entries</span>
                    </h3>
                    <div id="feedback-table-container" class="overflow-x-auto">
                        <p class="text-center text-slate-500 py-4">Memuat data...</p>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script>
        // ==================== CONFIGURATION ====================
        // API Base URL - akan auto-detect local atau production
        const API_BASE_URL = window.location.origin.includes('localhost')
            ? 'http://localhost:3000/api'
            : `${window.location.origin}/api`;

        const GOOGLE_SCRIPT_URL = `${API_BASE_URL}/submit`;
        const DATA_API_URL = `${API_BASE_URL}/data`;
        const ANALYZE_API_URL = `${API_BASE_URL}/analyze`;
        let ADMIN_PASSWORD = "admin123"; // Default password, will be overwritten by env

        // Fetch admin password from server
        fetch('/api/config')
            .then(res => res.json())
            .then(data => { if (data.adminPassword) ADMIN_PASSWORD = data.adminPassword; })
            .catch(() => { });

        // ==================== STATE ====================
        let dashboardData = [];
        let isAdminMode = false;

        // ==================== PENGHARGAAN FORM LOGIC ====================
        let isPenghargaanMode = false;

        function getTodayKey() {
            const d = new Date();
            return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        }

        function hasSubmittedPenghargaanToday() {
            try {
                const saved = localStorage.getItem('penghargaan_last_date');
                return saved === getTodayKey();
            } catch (e) { return false; }
        }

        function togglePenghargaan() {
            const penghargaanForm = document.getElementById('penghargaan-form');
            const customerForm = document.getElementById('customer-form');
            const limitMsg = document.getElementById('penghargaan-limit-msg');
            const penghargaanBtn = document.getElementById('penghargaanBtn');
            const formEl = document.getElementById('penghargaanForm');

            if (isPenghargaanMode) {
                penghargaanForm.classList.add('hidden-section');
                customerForm.classList.remove('hidden-section');
                isPenghargaanMode = false;
            } else {
                customerForm.classList.add('hidden-section');
                penghargaanForm.classList.remove('hidden-section');
                isPenghargaanMode = true;
                // Ketelusan: had satu penghargaan per peranti per hari
                if (hasSubmittedPenghargaanToday()) {
                    limitMsg.classList.remove('hidden');
                    penghargaanBtn.disabled = true;
                    formEl.querySelectorAll('input, select, textarea').forEach(el => { el.disabled = true; });
                } else {
                    limitMsg.classList.add('hidden');
                    penghargaanBtn.disabled = false;
                    formEl.querySelectorAll('input, select, textarea').forEach(el => { el.disabled = false; });
                }
            }
            window.scrollTo(0, 0);
        }

        document.getElementById('penghargaanForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('penghargaanBtn');
            const btnText = document.getElementById('penghargaanBtnText');
            const loader = document.getElementById('penghargaanBtnLoader');

            // UI Loading State
            btn.disabled = true;
            btnText.innerText = "Sedang Hantar...";
            loader.classList.remove('hidden');

            // Collect form data
            const formData = new FormData(this);
            const namaPegawai = formData.get('nama_pegawai');
            const kaunter = formData.get('kaunter_penghargaan');
            const ucapan = formData.get('ucapan_penghargaan') || '';
            const namaPemberi = (formData.get('nama_pemberi') || '').trim();
            let telefon4 = (formData.get('telefon_4digit') || '').trim().replace(/\D/g, '');
            if (telefon4.length > 4) telefon4 = telefon4.slice(-4);

            // Bukti pemberi: wajib salah satu (nama atau 4 digit telefon) untuk ketelusan
            if (!namaPemberi && !telefon4) {
                alert('Sila isi nama pemberi atau 4 digit terakhir no. telefon untuk ketelusan.');
                btn.disabled = false;
                btnText.innerText = "Hantar Penghargaan";
                loader.classList.add('hidden');
                return;
            }

            const pemberiPart = [];
            if (namaPemberi) pemberiPart.push('Nama - ' + namaPemberi);
            if (telefon4) pemberiPart.push('Tel: ' + telefon4);
            const pemberiStr = ' [Pemberi: ' + pemberiPart.join(' | ') + ']';

            // Prepare data for submission (mark as penghargaan with special format)
            const data = {
                kaunter: kaunter,
                tujuan: 'PENGHARGAAN STAF',
                skor_mesra: 5,
                skor_pantas: 5,
                skor_jelas: 5,
                kategori_perbaikan: '',
                ulasan: `PENGHARGAAN kepada ${namaPegawai}: ${ucapan}${pemberiStr}`,
                nama_pegawai: namaPegawai,
                is_penghargaan: true
            };

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json().catch(() => ({}));

                if (!response.ok) {
                    throw new Error(result.error || 'Ralat semasa menghantar');
                }

                // Simpan tarikh untuk had 1 penghargaan per hari (ketelusan)
                try {
                    localStorage.setItem('penghargaan_last_date', getTodayKey());
                } catch (e) {}

                // Papar No. Rujukan untuk semakan
                const rujukan = result.rujukan || new Date().toISOString();
                const rujukanDisplay = rujukan.replace('T', ' ').substring(0, 19);
                document.getElementById('penghargaan-rujukan-display').innerText = rujukanDisplay;

                document.getElementById('penghargaan-nama-display').innerText = namaPegawai;
                document.getElementById('penghargaan-kaunter-display').innerText = kaunter;

                document.getElementById('penghargaan-form').classList.add('hidden-section');
                document.getElementById('penghargaan-success').classList.remove('hidden-section');
                window.scrollTo(0, 0);

            } catch (err) {
                console.error('Error:', err);
                alert('Ralat semasa menghantar. Sila cuba lagi.');
                btn.disabled = false;
                btnText.innerText = "Hantar Penghargaan";
                loader.classList.add('hidden');
            }
        });

        // ==================== CUSTOMER FORM LOGIC ====================
        document.getElementById('feedbackForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const btn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('btnLoader');

            // Validate ratings
            const skorMesra = document.querySelector('input[name="skor_mesra"]:checked');
            const skorPantas = document.querySelector('input[name="skor_pantas"]:checked');
            const skorJelas = document.querySelector('input[name="skor_jelas"]:checked');

            if (!skorMesra || !skorPantas || !skorJelas) {
                alert('Sila beri penilaian bintang untuk semua kategori.');
                return;
            }

            // UI Loading State
            btn.disabled = true;
            btnText.innerText = "Sedang Hantar...";
            loader.classList.remove('hidden');

            // Collect form data
            const formData = new FormData(this);

            // Handle multi-select checkboxes - combine into comma-separated string
            const checkboxes = document.querySelectorAll('input[name="kategori_perbaikan"]:checked');
            const kategoriValues = Array.from(checkboxes).map(cb => cb.value).join(', ');

            // Create final data object matching Google Sheets columns
            const data = {
                kaunter: formData.get('kaunter'),
                tujuan: formData.get('tujuan'),
                skor_mesra: formData.get('skor_mesra'),
                skor_pantas: formData.get('skor_pantas'),
                skor_jelas: formData.get('skor_jelas'),
                kategori_perbaikan: kategoriValues,
                ulasan: formData.get('ulasan') || ''
            };

            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    let errorMessage = 'Ralat semasa menghantar. Sila cuba lagi.';
                    try {
                        const payload = await response.json();
                        if (payload && payload.error) errorMessage = payload.error;
                    } catch (_) { }
                    throw new Error(errorMessage);
                }

                document.getElementById('customer-form').classList.add('hidden-section');
                document.getElementById('success-screen').classList.remove('hidden-section');
                window.scrollTo(0, 0);

            } catch (err) {
                console.error('Error:', err);
                alert(err && err.message ? err.message : "Ralat semasa menghantar. Sila cuba lagi.");
                btn.disabled = false;
                btnText.innerText = "Hantar Penilaian";
                loader.classList.add('hidden');
            }
        });

        // ==================== ADMIN DASHBOARD LOGIC ====================
        function toggleAdmin() {
            const dashboard = document.getElementById('admin-dashboard');
            const form = document.getElementById('customer-form');
            const successScreen = document.getElementById('success-screen');

            if (isAdminMode) {
                // Switch back to customer form
                dashboard.classList.add('hidden-section');
                form.classList.remove('hidden-section');
                successScreen.classList.add('hidden-section');
                isAdminMode = false;
            } else {
                // Switch to admin dashboard
                form.classList.add('hidden-section');
                successScreen.classList.add('hidden-section');
                dashboard.classList.remove('hidden-section');
                isAdminMode = true;
                window.scrollTo(0, 0);
            }
        }

        function checkAdmin() {
            const pass = document.getElementById('adminPass').value;
            if (pass === ADMIN_PASSWORD) {
                document.getElementById('admin-login').classList.add('hidden-section');
                document.getElementById('dashboard-content').classList.remove('hidden-section');
                loadDashboardData();
                setTimeout(initQRCode, 100); // Initialize QR code after dashboard shows
            } else {
                alert('Kata laluan salah!');
            }
        }

        function logoutAdmin() {
            document.getElementById('admin-login').classList.remove('hidden-section');
            document.getElementById('dashboard-content').classList.add('hidden-section');
            document.getElementById('adminPass').value = '';
        }

        // ==================== DATA FETCHING ====================
        async function loadDashboardData() {
            const container = document.getElementById('feedback-table-container');
            container.innerHTML = '<p class="text-center text-slate-500 py-4">Memuat data...</p>';

            try {
                // Fetch data from API
                const response = await fetch(DATA_API_URL, {
                    method: 'GET',
                    mode: 'cors'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch data');
                }

                const payload = await response.json();
                const rows = Array.isArray(payload) ? payload : (payload && Array.isArray(payload.data) ? payload.data : []);
                dashboardData = rows;

                updateStats(rows);
                renderFeedbackTable(rows);

                const container = document.getElementById('feedback-table-container');
                // Papar mesej ralat sebenar (kredensial / Google API)
                const errMsg = payload.error || (rows.length === 0 && payload.message ? payload.message : null);
                if (errMsg) {
                    const msg = document.createElement('div');
                    msg.className = 'bg-red-50 border border-red-200 text-red-800 p-3 rounded-lg text-sm mb-3';
                    msg.innerHTML = '<strong>Ralat:</strong> ' + errMsg;
                    container.insertBefore(msg, container.firstChild);
                }

            } catch (error) {
                console.error('Error loading data:', error);
                // Show demo data if fetch fails
                showDemoData();
            }
        }

        function updateStats(data) {
            if (!data || data.length === 0) {
                document.getElementById('stat-total').innerText = '0';
                document.getElementById('stat-avg').innerText = '0.0';
                document.getElementById('stat-mesra').innerText = '-';
                document.getElementById('stat-pantas').innerText = '-';
                document.getElementById('stat-jelas').innerText = '-';
                document.getElementById('feedback-count').innerText = '0 entries';
                document.getElementById('penghargaan-count').innerText = '0';
                return;
            }

            // Separate penghargaan from regular feedback
            const penghargaanData = data.filter(row =>
                row.ulasan && row.ulasan.toUpperCase().startsWith('PENGHARGAAN')
            );
            const regularData = data.filter(row =>
                !row.ulasan || !row.ulasan.toUpperCase().startsWith('PENGHARGAAN')
            );

            const total = data.length;
            let sumMesra = 0, sumPantas = 0, sumJelas = 0;

            data.forEach(row => {
                sumMesra += parseFloat(row.skor_mesra) || 0;
                sumPantas += parseFloat(row.skor_pantas) || 0;
                sumJelas += parseFloat(row.skor_jelas) || 0;
            });

            const avgMesra = total > 0 ? (sumMesra / total).toFixed(1) : '-';
            const avgPantas = total > 0 ? (sumPantas / total).toFixed(1) : '-';
            const avgJelas = total > 0 ? (sumJelas / total).toFixed(1) : '-';
            const overallAvg = total > 0 ? ((sumMesra + sumPantas + sumJelas) / (total * 3)).toFixed(1) : '0.0';

            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-avg').innerText = overallAvg;
            document.getElementById('stat-mesra').innerText = avgMesra;
            document.getElementById('stat-pantas').innerText = avgPantas;
            document.getElementById('stat-jelas').innerText = avgJelas;
            document.getElementById('feedback-count').innerText = total + ' entries';

            // Update penghargaan stats
            document.getElementById('penghargaan-count').innerText = penghargaanData.length;
            renderPenghargaanList(penghargaanData);
        }

        function renderPenghargaanList(penghargaanData) {
            const container = document.getElementById('penghargaan-list');

            if (!penghargaanData || penghargaanData.length === 0) {
                container.innerHTML = '<p class="text-sm text-orange-700 text-center py-2">Tiada penghargaan direkodkan</p>';
                return;
            }

            // Parse penghargaan data (ucapan + pemberi untuk semakan)
            const parsed = penghargaanData.map(row => {
                const ulasan = row.ulasan || '';
                const match = ulasan.match(/PENGHARGAAN kepada (.+?):(.*)/i);
                let ucapanFull = match ? match[2].trim() : ulasan;
                const pemberiMatch = ucapanFull.match(/\s*\[Pemberi:\s*([^\]]+)\]\s*$/);
                const ucapanDisplay = pemberiMatch ? ucapanFull.replace(/\s*\[Pemberi:\s*[^\]]+\]\s*$/, '').trim() : ucapanFull;
                const pemberiDisplay = pemberiMatch ? pemberiMatch[1].trim() : '';
                return {
                    nama: match ? match[1].trim() : 'Tidak diketahui',
                    ucapan: ucapanDisplay,
                    pemberi: pemberiDisplay,
                    kaunter: row.kaunter || '-',
                    timestamp: row.timestamp || '-'
                };
            });

            let html = '';
            parsed.slice(0, 10).forEach(p => {
                html += `
                    <div class="bg-white rounded-lg p-3 border border-yellow-200 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-bold text-orange-900 text-sm">${p.nama}</p>
                                <p class="text-xs text-slate-500">${p.kaunter} ‚Ä¢ ${p.timestamp}</p>
                                ${p.ucapan ? `<p class="text-xs text-slate-600 mt-1 italic">"${p.ucapan}"</p>` : ''}
                                ${p.pemberi ? `<p class="text-xs text-amber-700 mt-1">Pemberi (semakan): ${p.pemberi}</p>` : ''}
                            </div>
                            <span class="text-xl">‚≠ê</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderFeedbackTable(data) {
            const container = document.getElementById('feedback-table-container');

            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-slate-500 py-4">Tiada data tersedia.</p>';
                return;
            }

            // Papar SEMUA rekod (maklum balas + penghargaan), paling baru dulu, max 20
            const recentData = data.slice(0, 20);

            let html = `
                <table class="w-full text-sm">
                    <thead class="bg-slate-100 text-slate-600">
                        <tr>
                            <th class="p-2 text-left rounded-tl-lg">Tarikh</th>
                            <th class="p-2 text-left">Jenis</th>
                            <th class="p-2 text-left">Kaunter</th>
                            <th class="p-2 text-left">Skor</th>
                            <th class="p-2 text-left rounded-tr-lg">Ulasan</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200">
            `;

            recentData.forEach(row => {
                const isPenghargaan = row.ulasan && row.ulasan.toUpperCase().startsWith('PENGHARGAAN');
                const jenis = isPenghargaan ? '<span class="bg-amber-100 text-amber-800 px-2 py-0.5 rounded text-xs">Penghargaan</span>' : '<span class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-xs">Maklum balas</span>';
                const avgScore = ((parseFloat(row.skor_mesra) + parseFloat(row.skor_pantas) + parseFloat(row.skor_jelas)) / 3).toFixed(1);
                let ulasanShort = row.ulasan || '-';
                if (isPenghargaan && ulasanShort.length > 40) ulasanShort = ulasanShort.substring(0, 40) + '...';
                else if (ulasanShort.length > 30) ulasanShort = ulasanShort.substring(0, 30) + '...';

                html += `
                    <tr class="hover:bg-slate-50">
                        <td class="p-2 text-slate-600">${row.timestamp || '-'}</td>
                        <td class="p-2">${jenis}</td>
                        <td class="p-2">${row.kaunter || '-'}</td>
                        <td class="p-2">
                            <span class="bg-blue-100 text-blue-700 px-2 py-1 rounded font-semibold">${avgScore}</span>
                        </td>
                        <td class="p-2 text-slate-600" title="${(row.ulasan || '').replace(/"/g, '&quot;')}">${ulasanShort}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showDemoData() {
            // Tiada data demo ‚Äì papar kosong apabila fetch gagal (Sheet tidak disambung)
            dashboardData = [];
            updateStats([]);
            renderFeedbackTable([]);

            const container = document.getElementById('feedback-table-container');
            container.innerHTML = '<div class="bg-amber-50 border border-amber-200 text-amber-800 p-3 rounded-lg text-sm mb-3">Tiada data. Sambungkan Google Sheets (kredensial + SPREADSHEET_ID) untuk melihat maklum balas sebenar.</div><p class="text-center text-slate-500 py-4">Tiada data tersedia.</p>';
        }

        // ==================== GEMINI AI INTEGRATION ====================
        async function runGeminiAnalysis() {
            const aiBtn = document.getElementById('aiBtn');
            const aiBtnText = document.getElementById('aiBtnText');
            const aiSpinner = document.getElementById('aiSpinner');
            const aiResult = document.getElementById('ai-result');

            // UI Loading State
            aiBtn.disabled = true;
            aiBtnText.innerText = "Sedang menganalisis...";
            aiSpinner.classList.remove('hidden');
            aiResult.innerText = "Menghubungi Gemini AI untuk analisis...";

            try {
                const response = await fetch(ANALYZE_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    aiResult.innerText = data.analysis;
                    if (data.commentCount) {
                        aiResult.innerText = `Ulasan dianalisis: ${data.commentCount}\n\n${data.analysis}`;
                    }
                } else if (data.demo) {
                    // Demo mode - API key not configured
                    aiResult.innerText = data.analysis || "API key tidak dikonfigurasi. Sila tambah GEMINI_API_KEY dalam environment variable Vercel.";
                } else {
                    aiResult.innerText = `Ralat: ${data.error || 'Unknown error'}`;
                }

            } catch (error) {
                console.error('Analysis Error:', error);
                aiResult.innerText = "Gagal menyambung ke server analisis. Sila periksa:\n1. Sambungan internet\n2. Pastikan server berjalan (npm run dev)";
            } finally {
                aiBtn.disabled = false;
                aiBtnText.innerText = "Jana Analisis Sentimen";
                aiSpinner.classList.add('hidden');
            }
        }

        // ==================== QR CODE GENERATOR ====================
        let qrCodeInstance = null;

        function initQRCode() {
            const urlInput = document.getElementById('qrUrl');
            // Auto-detect current URL
            const currentUrl = window.location.origin.includes('localhost')
                ? window.location.origin
                : window.location.origin;
            urlInput.value = currentUrl;
            generateQR();
        }

        function generateQR() {
            const url = document.getElementById('qrUrl').value || window.location.origin;
            const qrContainer = document.getElementById('qrcode');

            // Clear previous QR code
            qrContainer.innerHTML = '';

            // Generate new QR code
            qrCodeInstance = new QRCode(qrContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#1e40af",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function printQR() {
            const qrContainer = document.getElementById('qrcode');
            const img = qrContainer.querySelector('img');
            const logoSrc = 'perkeso-logo.jpg';

            if (!img) {
                alert('Sila jana QR code terlebih dahulu');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Cetak QR Code - PERKESO Keningau</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            text-align: center; 
                            padding: 20px;
                        }
                        .container {
                            max-width: 400px;
                            margin: 0 auto;
                            border: 3px solid #1e40af;
                            border-radius: 15px;
                            padding: 30px;
                            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                        }
                        .logo {
                            width: 80px;
                            height: 80px;
                            border-radius: 50%;
                            object-fit: cover;
                            margin-bottom: 15px;
                            border: 3px solid #1e40af;
                        }
                        h2 { 
                            color: #1e40af; 
                            margin-bottom: 5px;
                            font-size: 22px;
                        }
                        .subtitle {
                            color: #64748b;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        .qr-container {
                            background: white;
                            padding: 20px;
                            border-radius: 10px;
                            margin: 20px 0;
                            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                        }
                        .qr-img { 
                            max-width: 200px; 
                        }
                        .instructions {
                            background: #dbeafe;
                            color: #1e40af;
                            padding: 15px;
                            border-radius: 8px;
                            margin: 20px 0;
                            font-size: 14px;
                            font-weight: bold;
                        }
                        .address {
                            font-size: 11px;
                            color: #475569;
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 1px solid #cbd5e1;
                            line-height: 1.6;
                        }
                        .url {
                            font-size: 10px;
                            color: #94a3b8;
                            word-break: break-all;
                            margin-top: 10px;
                        }
                        .footer {
                            font-size: 10px;
                            color: #94a3b8;
                            margin-top: 15px;
                        }
                        @media print {
                            body { padding: 0; background: white; }
                            .container { box-shadow: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <img src="${logoSrc}" alt="Logo PERKESO" class="logo">
                        <h2>PERKESO KENINGAU</h2>
                        <p class="subtitle">Sistem Penilaian Pelanggan 1Serve</p>
                        
                        <div class="qr-container">
                            <img src="${img.src}" alt="QR Code" class="qr-img">
                        </div>
                        
                        <div class="instructions">
                            üì± Imbas QR code ini untuk beri maklum balas<br>
                            tentang perkhidmatan kami
                        </div>
                        
                        <div class="address">
                            <strong>PEJABAT PERKESO KENINGAU</strong><br>
                            Tingkat 1 & 2, Lot 22, Blok B,<br>
                            ADIKA Commercial Complex,<br>
                            Peti Surat 704, 89008 Keningau
                        </div>
                        
                        <p class="footer">Hak Cipta Terpelihara ¬© 2024 PERKESO Keningau</p>
                    </div>
                    <script>window.onload = () => { setTimeout(() => { window.print(); }, 500); }<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function downloadQR() {
            const qrContainer = document.getElementById('qrcode');
            const img = qrContainer.querySelector('img');

            if (!img) {
                alert('Sila jana QR code terlebih dahulu');
                return;
            }

            const link = document.createElement('a');
            link.download = 'perkeso-keningau-qr-code.png';
            link.href = img.src;
            link.click();
        }

        // ==================== INITIALIZATION ====================
        // Check URL params for admin mode
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mode') === 'admin') {
            toggleAdmin();
        }

        // Initialize QR code when dashboard loads
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver((mutations) => {
                const dashboardContent = document.getElementById('dashboard-content');
                if (!dashboardContent.classList.contains('hidden-section')) {
                    initQRCode();
                }
            });

            observer.observe(document.getElementById('dashboard-content'), {
                attributes: true,
                attributeFilter: ['class']
            });
        });
    </script>
</body>

</html>